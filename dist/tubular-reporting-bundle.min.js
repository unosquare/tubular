(function(n){"use strict";n.module("tubular-reporting.directives",["tubular.services"]).directive("tbReporting",[function(){return{template:'<div class="container"><tb-form model="Model"><div class="tubular-overlay" ng-show="showLoading"><\/div><tb-reporting-toolbar><\/tb-reporting-toolbar><br /><tb-reporting-columns-selector><\/tb-reporting-columns-selector><\/tb-form><button class="btn btn-xs btn-block" tooltip="Click to toggle" ng-click="isShowing = !isShowing"><i class="fa" ng-class="{\'fa-caret-down\' : !isShowing, \'fa-caret-up\' : isShowing, }"><\/i><\/button><hr /><div ng-include="autoCode"><\/div><\/div>',restrict:"E",replace:!0,scope:{serverDataSourceUrl:"@",serverMarkupUrl:"@",requireAuthentication:"=?"},controller:["$scope","tubularHttp","localStorageService",function(t,i,r){t.isShowing=!0;t.showLoading=!0;t.requireAuthentication=n.isUndefined(t.requireAuthentication)?!0:t.requireAuthentication;t.items=[];t.reports=r.get("reports")||[];i.setRequireAuthentication(t.requireAuthentication);i.get(t.serverDataSourceUrl||"api/reports/datasources").promise.then(function(n){t.dataSources=n.DataSources;t.aggregationFunctions=n.AggregationFunctions;t.types=n.Types},function(n){t.$emit("tbReporting_OnConnectionError",n)}).then(function(){t.showLoading=!1});t.addItem=function(){t.items.push({DataSource:t.Model.DataSource.Name,Column:t.Model.Column.Name,DataType:t.Model.DataType,Aggregation:t.Model.AggregationFunction,Filter:t.Model.Filter});t.Model.Filter=""};t.removeItem=function(n){var i=t.items.indexOf(n);i>-1&&t.items.splice(i,1)};t.moveItem=function(n,i){t.items.splice(i,0,t.items.splice(n,1)[0])};t.up=function(n){var i=t.items.indexOf(n);t.moveItem(i,i-1)};t.down=function(n){var i=t.items.indexOf(n);t.moveItem(i,i+1)};t.saveReport=function(){t.reports.push({Name:t.Model.CurrentReport,Data:t.items});r.set("reports",t.reports);t.$emit("tbReporting_OnSuccessfulSave","Report saved")};t.removeReport=function(){var n=t.reports.filter(function(n){return n.Name===t.Model.CurrentReport.Name}),i;n&&n[0]?(i=t.reports.indexOf(n[0]),i>-1&&(t.reports.splice(i,1),r.set("reports",t.reports),t.$emit("tbReporting_OnRemoved","Report removed"))):t.$emit("tbReporting_OnConnectionError","Unknown report")};t.loadReport=function(){var n=t.reports.filter(function(n){return n.Name===t.Model.CurrentReport.Name});n&&n[0]?t.items=n[0].Data:t.$emit("tbReporting_OnConnectionError","Unknown report")};t.isValid=function(){return t.items.length>0};t.generate=function(){i.setRequireAuthentication(t.requireAuthentication);i.post(t.serverMarkupUrl||"api/reports/getmarkup",t.items).promise.then(function(n){t.autoCode=window.URL.createObjectURL(new Blob([n],{type:"text/html"}))},function(n){t.$emit("tbReporting_OnConnectionError",n)}).then(function(){t.showLoading=!1})}}]}}]).directive("tbReportingToolbar",[function(){return{template:'<div class="row" ng-show="isShowing"><div class="col-md-3"><div class="pull-right clearfix"><tb-typeahead-editor name="CurrentReport" options="reports" option-label="Name" placeholder="Report name"><\/tb-typeahead-editor><\/div><\/div><div class="col-md-6"><div class="pull-right clearfix"><button class="btn btn-default" ng-click="loadReport()" ng-disabled="!Model.CurrentReport"><i class="fa fa-cloud-download"><\/i>&nbsp;{{\'CAPTION_LOAD\' | translate}}<\/button><button class="btn btn-default" ng-click="saveReport()" ng-disabled="!Model.CurrentReport"><i class="fa fa-cloud-upload"><\/i>&nbsp;{{\'CAPTION_SAVE\' | translate}}<\/button><button class="btn btn-default" ng-click="removeReport()" ng-disabled="!Model.CurrentReport.Name"><i class="fa fa-trash-o"><\/i>&nbsp;{{\'CAPTION_REMOVE\' | translate}}<\/button><\/div><\/div><div class="col-md-3"><div class="pull-right clearfix"><button class="btn btn-success" ng-disabled="items.length == 0" ng-click="generate()"><i class="fa fa-cogs"><\/i>&nbsp;{{\'UI_GENERATEREPORT\' | translate}}<\/button><\/div><\/div><\/div>',restrict:"E",replace:!0,scope:!1}}]).directive("tbReportingColumnsSelector",[function(){return{template:'<table class="table table-bordered" ng-show="isShowing"><thead><tr><th>Data Source<\/th><th>Column<\/th><th>Data Type<\/th><th>Aggregation<\/th><th>Filter Expression<\/th><th>&nbsp;<\/th><\/tr><\/thead><tbody><tr><td><tb-dropdown-editor name="DataSource" options="dataSources" option-label="Name"><\/tb-dropdown-editor><\/td><td><tb-dropdown-editor name="Column" options="Model.DataSource.Columns" option-label="Name" option-id="Name"><\/tb-dropdown-editor><\/td><td><tb-simple-editor name="DataType" read-only="true" value="types[Model.Column.DataType]"><\/tb-simple-editor><\/td><td><tb-dropdown-editor name="AggregationFunction" options="aggregationFunctions"><\/tb-dropdown-editor><\/td><td><tb-simple-editor name="Filter"><\/tb-simple-editor><\/td><td class="text-center"><button class="btn btn-success btn-sm" ng-click="addItem()">{{\'CAPTION_ADD\' | translate}}<\/button><\/td><\/tr><tr ng-repeat="item in items"><td>{{item.DataSource}}<\/td><td>{{item.Column}}<\/td><td>{{item.DataType}}<\/td><td><select class="form-control" ng-model="item.Aggregation" ng-options="a for a in aggregationFunctions"><\/select><\/td><td><input type="text" class="form-control" ng-model="item.Filter" /><\/td><td class="text-center"><div class="btn-group"><button class="btn btn-sm" ng-click="up(item)" ng-disabled="$first"><i class="fa fa-chevron-up"><\/i><\/button><button class="btn btn-sm" ng-click="down(item)" ng-disabled="$last"><i class="fa fa-chevron-down"><\/i><\/button><button class="btn btn-danger btn-sm" ng-click="removeItem(item)"><i class="fa fa-trash"><\/i><\/button><\/div><\/td><\/tr><\/tbody><\/table>',restrict:"E",replace:!0,scope:!1}}]).config(["$sceDelegateProvider",function(n){n.resourceUrlWhitelist(["self","blob:**"])}])})(window.angular);